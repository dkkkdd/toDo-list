// Объект `state` хранит текущее состояние формы.
// Он не экспортируется напрямую, чтобы нельзя было изменить состояние извне.
const state = {
  // Флаг, указывающий, находится ли форма в режиме редактирования проекта.
  isEditMode: false,

  // ID проекта, который в данный момент редактируется (если есть).
  // null — если форма используется для создания нового проекта.
  projectToEdit: null,
};

// Множество функций-подписчиков, которые будут вызываться при изменении состояния.
// Используется Set, чтобы избежать дубликатов подписчиков.
const subscribers = new Set();

export const formStore = {
  getState() {
    // Возвращаем новый объект, копируя поля `state`.
    // Это защищает внутреннее состояние от прямых изменений извне.
    return { ...state };
  },

  /**
   * Переключает форму в режим редактирования или создания.
   *
   * @param {string|null} id — ID проекта, который нужно отредактировать.
   * Если `id` не передан (или равен null), форма переходит в режим создания.
   */
  setEditMode(id = null) {
    // Если передан id, значит форма должна быть в режиме редактирования.
    state.isEditMode = !!id; // true, если id есть, иначе false.
    state.projectToEdit = id;

    // Уведомляем всех подписчиков о смене состояния.
    this.notify();
  },

  /**
   * Сбрасывает состояние формы в исходное (режим создания).
   * Используется, когда пользователь завершил редактирование или очистил форму.
   */
  reset() {
    state.isEditMode = false;
    state.projectToEdit = null;

    // Уведомляем подписчиков о сбросе состояния.
    this.notify();
  },

  /**
   * Добавляет нового подписчика, который будет вызван при изменении состояния.
   *
   * @param {Function} callback — функция, которая принимает новое состояние.
   * @returns {Function} Функция отписки — вызов её удаляет подписку.
   */
  subscribe(callback) {
    subscribers.add(callback);

    // Возвращаем "отписчик", чтобы можно было легко удалить слушателя при необходимости.
    // Например:
    // const unsubscribe = formStore.subscribe(handler);
    // ...
    // unsubscribe(); // чтобы перестать получать обновления.
    return () => subscribers.delete(callback);
  },

  /**
   * Уведомляет всех подписчиков об изменении состояния.
   * Каждый подписчик получает актуальное состояние через `getState()`.
   */
  notify() {
    subscribers.forEach((fn) => fn(this.getState()));
  },
};
